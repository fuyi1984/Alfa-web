$(function(){gtoken=ReadCookie("token");if(gtoken!=""){setCurrentUser();$("#useradd").window("close");$("#userupdate").window("close");$("#usersearch").window("close");initdatagrid();initcombobox()}else{window.location.href=platform_url+"/pages/home/login.html"}});function initdatagrid(){$("#usergrid").datagrid({title:"用户管理 ",singleSelect:false,iconCls:"icon-save",collapsible:true,nowrap:false,striped:true,loader:a,sortName:"createdDt",sortOrder:"desc",remoteSort:true,fitColumns:true,fit:true,toolbar:["-",{id:"btnSave",text:"添加",iconCls:"icon-add",handler:function(){$("#rolelist").combobox({reload:ws_url+"/rest/roles/findAllRole?token="+gtoken});$("#useradd").window("open")}},"-",{id:"btnUpdate",text:"修改",iconCls:"icon-save",handler:function(){var b=$("#usergrid").datagrid("getSelections");if(!b||b.length==0){$.messager.alert("提示","请选择要修改的数据");return}else{if(b.length>1){$.messager.alert("提示","请选择一条数据");$("#usergrid").datagrid("clearSelections");return}else{$("#rolelist_update").combobox({reload:ws_url+"/rest/roles/findAllRole?token="+gtoken});$("#form2").form("load",{userId_update:b[0].userId,realname_update:b[0].realname,rolelist_update:b[0].roleId,phone_update:b[0].username,address_update:b[0].address,orgname_update:b[0].orgname});$("#userupdate").window("open")}}}},"-",{id:"btnDelete",text:"删除",disabled:false,iconCls:"icon-cut",handler:function(){var d=$("#usergrid").datagrid("getSelections");if(!d||d.length==0){$.messager.alert("提示","请选择要删除的数据");return}console.log(d);console.log(d[0].userId);for(var c=0;c<d.length;c++){if(d[c].userId==guserid){$.messager.alert("提示","不能删除当前登录用户!");$("#usergrid").datagrid("clearSelections");return}}var b=new Array();$.each(d,function(e,f){b.push(f.userId)});$.messager.confirm("提示","是否删除这些数据?",function(e){if(!e){return}$.ajax({cache:false,datatype:"json",contentType:"application/json;charset=UTF-8",type:"POST",url:ws_url+"/rest/user/batchdeleteUser?token="+gtoken,data:JSON.stringify(b),success:function(f){if(f.status=="success"){$.messager.alert("提示","删除成功！","info",function(){$("#usergrid").datagrid("clearSelections");$("#usergrid").datagrid("reload")})}else{$.messager.alert("错误","删除失败！","error",function(){$("#usergrid").datagrid("clearSelections");$("#usergrid").datagrid("reload")})}},error:function(f){console.log(f);$("#usergrid").datagrid("clearSelections");$.messager.alert("错误","删除失败！","error")}})})}},"-",{id:"btnSearch",text:"查询",disabled:false,iconCls:"icon-search",handler:function(){$("#usersearch").window("open")}},"-"],idField:"userId",frozenColumns:[[{field:"userId",checkbox:true}]],columns:[[{field:"username",title:"用户名",width:80,align:"center"},{field:"realname",title:"真实姓名",width:80,align:"center"},{field:"role_name",title:"角色",width:80,align:"center"},{field:"phone",title:" 联系电话",width:80,align:"center"},{field:"address",title:"地址",width:120,align:"center"},{field:"orgname",title:"单位名称",width:120,align:"center"},{field:"loginIp",title:"IP地址",width:80,align:"center"},{field:"createdBy",title:"创建人",width:80,align:"center"},{field:"createdDt",title:"创建时间",width:100,align:"center"},{field:"updatedBy",title:"更新人",width:80,align:"center"},{field:"updatedDt",title:"更新时间",width:100,align:"center",}]],pagination:true,rownumbers:true});function a(g,f,c){console.log(g);var b=g.page-1;var d=g.rows;var e=g.page==1?0:g.rows*(g.page-1);var h=g.rows*g.page;$.ajax({url:ws_url+"/rest/user/findlist?token="+gtoken,type:"post",data:"filterscount=0&groupscount=0&pagenum="+b+"&pagesize="+d+"&recordstartindex="+e+"&recordendindex="+h+"&username="+$("#username_search").val()+"",contentType:"application/json;charset=UTF-8",success:function(i){console.log(i);$("#usergrid").datagrid("clearSelections");$("#form3").form("clear");f(i)},error:function(i){console.log(i);c(i.responseText)}})}}function initcombobox(){$("#rolelist_update").combobox({url:ws_url+"/rest/roles/findAllRole?token="+gtoken,method:"get",valueField:"roleId",textField:"role_name",icons:[{iconCls:"icon-reload",handler:function(){$("#rolelist_update").combobox({reload:ws_url+"/rest/roles/findAllRole?token="+gtoken})}}]});$("#rolelist").combobox({url:ws_url+"/rest/roles/findAllRole?token="+gtoken,method:"get",valueField:"roleId",textField:"role_name",icons:[{iconCls:"icon-reload",handler:function(){$("#rolelist").combobox({reload:ws_url+"/rest/roles/findAllRole?token="+gtoken})}}]})};